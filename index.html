<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>äººç‹¼GMè£œåŠ©ãƒ„ãƒ¼ãƒ«</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: sans-serif; margin: 10px; background: #f4f4f4; }
h1 { font-size: 20px; text-align: center; }
.section { margin: 15px 0; padding: 10px; background: #fff; border-radius: 8px; }
button { padding: 8px 15px; margin: 5px; border: none; border-radius: 5px; background: #007bff; color: white; }
button:disabled { background: gray; }
select { padding: 8px; margin: 5px; width: 100%; }
.player { padding: 5px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
#log { max-height: 250px; overflow-y: auto; background: #eee; padding: 10px; border-radius: 5px; font-size: 14px; }
</style>
</head>
<body>
<h1>äººç‹¼GMè£œåŠ©ãƒ„ãƒ¼ãƒ«</h1>

<div id="setup" class="section">
  <h2>åˆæœŸè¨­å®š</h2>
  <label>äººæ•°:
    <select id="playerCount">
      <option value="6">6äººæ‘</option>
      <option value="7">7äººæ‘</option>
    </select>
  </label>
  <label>çµ„åˆ†ã‘:
    <select id="pattern"></select>
  </label>
  <button onclick="setRoles()">å½¹è·ã‚’æ±ºå®š</button>
</div>

<div id="assign" class="section" style="display:none;">
  <h2>å½¹è·å‰²ã‚Šå½“ã¦</h2>
  <div id="players"></div>
  <button onclick="confirmRoles()">ç¢ºèª</button>
</div>

<div id="game" class="section" style="display:none;">
  <h2>ã‚²ãƒ¼ãƒ é€²è¡Œ</h2>
  <div id="log"></div>
  <button onclick="startDay()">æ˜¼ã®ã‚¿ãƒ¼ãƒ³</button>
  <button onclick="startNight()">å¤œã®ã‚¿ãƒ¼ãƒ³</button>
  <div id="actions"></div>
</div>

<script>
const rolePatterns = {
  6: {
    "åˆå¿ƒè€…": ["æ‘äºº","æ‘äºº","æ‘äºº","äººç‹¼","å ã„å¸«","é¨å£«"],
    "ä¸­ä¸Šç´š": ["æ‘äºº","æ‘äºº","äººç‹¼","å ã„å¸«","é¨å£«","ç‹‚äºº"],
    "ã‚¢ã‚°ãƒ¬ãƒƒã‚·ãƒ–1": ["æ‘äºº","æ‘äºº","äººç‹¼","å ã„å¸«","ç‹‚äºº","ãƒãƒ³ã‚¿ãƒ¼"]
  },
  7: {
    "åˆå¿ƒè€…": ["æ‘äºº","æ‘äºº","äººç‹¼","äººç‹¼","å ã„å¸«","é¨å£«","éœŠåª’å¸«"],
    "ä¸­ä¸Šç´š": ["æ‘äºº","æ‘äºº","äººç‹¼","å ã„å¸«","é¨å£«","ç‹‚äºº","éœŠåª’å¸«"],
    "ã‚¢ã‚°ãƒ¬ãƒƒã‚·ãƒ–1": ["æ‘äºº","äººç‹¼","äººç‹¼","å ã„å¸«","é¨å£«","éœŠåª’å¸«","å¦–ç‹"],
    "ã‚¢ã‚°ãƒ¬ãƒƒã‚·ãƒ–2": ["æ‘äºº","äººç‹¼","å ã„å¸«","ç‹‚äºº","ãƒãƒ³ã‚¿ãƒ¼","å¦–ç‹","å¦–ç‹"]
  }
};

let currentRoles = [];
let assignedRoles = [];
let deadPlayers = [];
let pendingHunter = null;
let lastExecuted = null;
let pendingVictim = null;
let roleIndexTracker = {}; // å½¹è·åˆ‡æ›¿ç”¨

// åˆæœŸè¨­å®š
document.getElementById("playerCount").addEventListener("change", updatePattern);
function updatePattern(){
  let count = document.getElementById("playerCount").value;
  let patternSel = document.getElementById("pattern");
  patternSel.innerHTML = "";
  for (let key in rolePatterns[count]){
    let opt = document.createElement("option");
    opt.value = key; opt.textContent = key;
    patternSel.appendChild(opt);
  }
}
updatePattern();

// å½¹è·ã‚»ãƒƒãƒˆ
function setRoles(){
  let count = document.getElementById("playerCount").value;
  let pattern = document.getElementById("pattern").value;
  currentRoles = [...rolePatterns[count][pattern]];
  document.getElementById("setup").style.display = "none";
  document.getElementById("assign").style.display = "block";
  let container = document.getElementById("players");
  container.innerHTML = "";
  currentRoles.forEach((r, i)=>{
    roleIndexTracker[i] = 0;
    let div = document.createElement("div");
    div.className = "player";
    div.innerHTML = `
      ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}:
      <button onclick="cycleRole(${i})">åˆ‡æ›¿</button>
      <button onclick="confirmRole(${i})">ç¢ºå®š</button>
      <span id="p${i}">æœªé¸æŠ</span>
    `;
    container.appendChild(div);
  });
}

// å½¹è·åˆ‡æ›¿
function cycleRole(i){
  let available = rolePatterns[document.getElementById("playerCount").value][document.getElementById("pattern").value];
  roleIndexTracker[i] = (roleIndexTracker[i] + 1) % available.length;
  document.getElementById("p"+i).textContent = available[roleIndexTracker[i]];
}

// å½¹è·ç¢ºå®š
function confirmRole(i){
  let available = rolePatterns[document.getElementById("playerCount").value][document.getElementById("pattern").value];
  let role = available[roleIndexTracker[i]];
  if(currentRoles.includes(role)){
    assignedRoles[i] = role;
    currentRoles.splice(currentRoles.indexOf(role),1);
    document.getElementById("p"+i).textContent = role + " âœ…";
    log(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1} ã« ${role} ã‚’å‰²ã‚Šå½“ã¦ã¾ã—ãŸ`);
  } else {
    alert("ãã®å½¹è·ã¯ã™ã§ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™");
  }
}

function confirmRoles(){
  if(assignedRoles.length===0){ alert("å½¹è·ã‚’å‰²ã‚Šå½“ã¦ã¦ãã ã•ã„"); return; }
  document.getElementById("assign").style.display = "none";
  document.getElementById("game").style.display = "block";
  log("å½¹è·ãŒæ±ºå®šã—ã¾ã—ãŸã€‚ã‚²ãƒ¼ãƒ é–‹å§‹ï¼");
}

function log(msg){
  let logDiv = document.getElementById("log");
  let p = document.createElement("p");
  p.textContent = msg;
  logDiv.appendChild(p);
  logDiv.scrollTop = logDiv.scrollHeight;
}

// --- æ˜¼ã®å‡¦ç† ---
function startDay(){
  log("ğŸŒ… æ˜¼ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚æ˜¨å¤œã®çŠ ç‰²è€…ã‚’ç™ºè¡¨ã—ã¦ãã ã•ã„ã€‚");
  if(pendingHunter!==null){
    log("ãƒãƒ³ã‚¿ãƒ¼ãŒå¤œã«æ­»äº¡ã—ã¦ã„ã¾ã—ãŸã€‚é“é€£ã‚Œå¯¾è±¡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
    showSelect("ãƒãƒ³ã‚¿ãƒ¼ã®é“é€£ã‚Œå¯¾è±¡", hunterKill, true);
    pendingHunter = null;
  } else {
    showSelect("çŠ ç‰²è€…ã‚’é¸æŠï¼ˆãªã—å¯ï¼‰", announceVictim, true);
  }
}

function announceVictim(player){
  if(player !== null){
    deadPlayers.push(player);
    log(`æ˜¨å¤œã®çŠ ç‰²è€…ã¯ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player+1} (${assignedRoles[player]}) ã§ã™ã€‚`);
    checkHunter(player,"attack");
  } else {
    log("æ˜¨å¤œã®çŠ ç‰²è€…ã¯ã„ã¾ã›ã‚“ã§ã—ãŸã€‚");
  }
  checkVictory();
}

// --- å¤œã®å‡¦ç† (äººç‹¼â†’å ã„å¸«â†’éœŠåª’å¸«â†’é¨å£«) ---
function startNight(){
  log("ğŸŒ™ å¤œã®ã‚¿ãƒ¼ãƒ³é–‹å§‹");
  processWerewolf();
}

function processWerewolf(){
  showSelect("äººç‹¼ã®è¥²æ’ƒå¯¾è±¡ï¼ˆãªã—å¯ï¼‰", target=>{
    if(target!==null){
      log(`äººç‹¼ãŒè¥²æ’ƒå¯¾è±¡ã«é¸ã‚“ã ã®ã¯ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${target+1}`);
      pendingVictim = target;
    } else {
      log("äººç‹¼ã¯è¥²æ’ƒã—ã¾ã›ã‚“ã§ã—ãŸã€‚");
      pendingVictim = null;
    }
    processSeer();
  }, true);
}

function processSeer(){
  const seerIndex = assignedRoles.findIndex(r=>r==="å ã„å¸«");
  if(seerIndex!==-1 && !deadPlayers.includes(seerIndex)){
    showSelect("å ã„å¸«ã®å ã„å¯¾è±¡ï¼ˆãªã—å¯ï¼‰", target=>{
      if(target!==null){
        const role = assignedRoles[target];
        if(role==="äººç‹¼"){
          log(`ğŸ”® å ã„å¸«ã®çµæœ: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${target+1} ã¯ äººç‹¼ã§ã™`);
        } else if(role==="å¦–ç‹"){
          log(`ğŸ”® å ã„å¸«ã®çµæœ: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${target+1} ã¯ å¦–ç‹ã§ã—ãŸ â†’ å ã„ã§æ­»äº¡ï¼`);
          deadPlayers.push(target);
        } else {
          log(`ğŸ”® å ã„å¸«ã®çµæœ: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${target+1} ã¯ äººç‹¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“`);
        }
      } else {
        log("å ã„å¸«ã¯å ã„ã‚’è¡Œã„ã¾ã›ã‚“ã§ã—ãŸã€‚");
      }
      processMedium();
    }, true);
  } else {
    processMedium();
  }
}

function processMedium(){
  const medIndex = assignedRoles.findIndex(r=>r==="éœŠåª’å¸«");
  if(medIndex!==-1 && !deadPlayers.includes(medIndex) && lastExecuted!==null){
    showSelect("éœŠåª’å¸«ãŒç¢ºèªï¼ˆãªã—å¯ï¼‰", target=>{
      log(`â˜ ï¸ éœŠåª’å¸«ã®çµæœ: å‰æ—¥ã®å‡¦åˆ‘è€… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${lastExecuted+1} ã¯ ${assignedRoles[lastExecuted]}`);
      processKnight();
    }, true);
  } else {
    processKnight();
  }
}

function processKnight(){
  const knightIndex = assignedRoles.findIndex(r=>r==="é¨å£«");
  if(knightIndex!==-1 && !deadPlayers.includes(knightIndex)){
    showSelect("é¨å£«ã®è­·è¡›å¯¾è±¡ï¼ˆãªã—å¯ï¼‰", target=>{
      if(target!==null && pendingVictim===target){
        log(`ğŸ›¡ é¨å£«ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${target+1}ã‚’å®ˆã£ãŸãŸã‚è¥²æ’ƒå¤±æ•—ï¼`);
        pendingVictim=null;
      } else if(target!==null){
        log(`ğŸ›¡ é¨å£«ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${target+1}ã‚’å®ˆã‚Šã¾ã—ãŸ`);
      } else {
        log("é¨å£«ã¯è­·è¡›ã‚’è¡Œã„ã¾ã›ã‚“ã§ã—ãŸ");
      }
      resolveNight();
    }, true);
  } else {
    resolveNight();
  }
}

function resolveNight(){
  if(pendingVictim!==null){
    let role = assignedRoles[pendingVictim];
    if(role==="å¦–ç‹"){
      log(`ğŸ¦Š è¥²æ’ƒã«ã‚ˆã‚Š ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${pendingVictim+1} ã¯ å¦–ç‹ã§ã—ãŸ â†’ å™›ã¾ã‚Œç„¡åŠ¹ï¼`);
    } else {
      deadPlayers.push(pendingVictim);
      log(`ğŸ’€ è¥²æ’ƒã«ã‚ˆã‚Š ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${pendingVictim+1} (${role}) ãŒæ­»äº¡ã—ã¾ã—ãŸ`);
      checkHunter(pendingVictim,"attack");
    }
  }
  checkVictory();
}

// --- æŠ•ç¥¨ã¨å‡¦åˆ‘ ---
function executePlayer(player){
  if(player !== null){
    deadPlayers.push(player);
    lastExecuted = player;
    log(`å‡¦åˆ‘ã•ã‚ŒãŸã®ã¯ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player+1} (${assignedRoles[player]})`);
    checkHunter(player,"execution");
  } else {
    log("ä»Šæ—¥ã¯å‡¦åˆ‘è€…ãŒã„ã¾ã›ã‚“ã§ã—ãŸ");
    lastExecuted=null;
  }
  checkVictory();
}

// --- å…±é€šUI ---
function showSelect(label, callback, allowNone=false){
  let actionDiv = document.getElementById("actions");
  actionDiv.innerHTML = `<p>${label}</p>`;
  let sel = document.createElement("select");
  sel.innerHTML = `<option value="">${allowNone?"ãªã—":"é¸æŠã—ã¦ãã ã•ã„"}</option>`;
  assignedRoles.forEach((r,i)=>{
    if(!deadPlayers.includes(i)){
      sel.innerHTML += `<option value="${i}">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1} (${r})</option>`;
    }
  });
  let btn = document.createElement("button");
  btn.textContent = "æ±ºå®š";
  btn.onclick = ()=>{
    let val = sel.value;
    if(val===""){ callback(null); }
    else{ callback(parseInt(val)); }
    actionDiv.innerHTML="";
  };
  actionDiv.appendChild(sel);
  actionDiv.appendChild(btn);
}

function checkHunter(player,cause){
  if(assignedRoles[player]==="ãƒãƒ³ã‚¿ãƒ¼"){
    if(cause==="execution"){
      log("ãƒãƒ³ã‚¿ãƒ¼ãŒå‡¦åˆ‘ã•ã‚Œã¾ã—ãŸã€‚ç›´å¾Œã«é“é€£ã‚Œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      showSelect("ãƒãƒ³ã‚¿ãƒ¼ã®é“é€£ã‚Œå¯¾è±¡", hunterKill);
    } else if(cause==="attack"){
      log("ãƒãƒ³ã‚¿ãƒ¼ãŒå¤œã«è¥²æ’ƒã•ã‚Œã¾ã—ãŸã€‚ç¿Œæœã«é“é€£ã‚ŒãŒç™ºç”Ÿã—ã¾ã™ã€‚");
      pendingHunter = player;
    }
  }
}

function hunterKill(target){
  if(target!==null){
    deadPlayers.push(target);
    log(`ãƒãƒ³ã‚¿ãƒ¼ã®é“é€£ã‚Œã§ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${target+1} (${assignedRoles[target]}) ãŒæ­»äº¡ã—ã¾ã—ãŸã€‚`);
  } else {
    log("ãƒãƒ³ã‚¿ãƒ¼ã¯èª°ã‚‚é“é€£ã‚Œã«ã—ã¾ã›ã‚“ã§ã—ãŸã€‚");
  }
  checkVictory();
}

// --- å‹åˆ©åˆ¤å®š ---
function checkVictory(){
  let alive = assignedRoles.map((r,i)=>deadPlayers.includes(i)?null:r);
  let wolves = alive.filter(r=>r==="äººç‹¼").length;
  let foxes  = alive.filter(r=>r==="å¦–ç‹").length;
  let villagers = alive.filter(r=>["æ‘äºº","å ã„å¸«","é¨å£«","éœŠåª’å¸«"].includes(r)).length;

  if(foxes>0 && wolves===0 && villagers===0){
    log("ğŸ‰ å¦–ç‹é™£å–¶ã®å‹åˆ©ï¼");
    endGame(); return;
  }
  if(wolves===0){
    log("ğŸ‰ æ‘äººé™£å–¶ã®å‹åˆ©ï¼");
    endGame(); return;
  }
  if(wolves >= villagers){
    log("ğŸ‰ äººç‹¼é™£å–¶ã®å‹åˆ©ï¼");
    endGame(); return;
  }
}

function endGame(){
  document.getElementById("actions").innerHTML="";
  document.querySelectorAll("#game button").forEach(b=>b.disabled=true);
}
</script>
</body>
</html>
